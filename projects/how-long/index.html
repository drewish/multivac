---
layout: full_width
title: How Long?
---
<style media="screen" type="text/css">

</style>

<div ng-app="sampleApp" ng-controller="SampleListCtrl">
  <div class="row">
    <div class="columns small-12">
      <p>Help goes here..</p>
    </div>
  </div>

  <div class="row">
    <div class="small-3 columns">
      <label for="final-count">Final Count</label>
      <input type="number" size="60" value="0" min="0" ng-model="target">
    </div>
    <div class="small-3 columns">
      <label for="rate">Rate</label>
      {(rate | number:3)} / minute
    </div>
    <div class="small-3 columns">
      <label for="estimated-time">Remaining</label>
      {(remaining)}
    </div>
    <div class="small-3 columns">
      <label for="estimated-time">Estimate</label>
      {(estimate | date:'short')}
    </div>
  </div>

  <div class="row">
    <div class="columns">
      <h3 class="subheader">Samples</h3>
    </div>
  </div>

  <div class="row">
    <div class="columns">
      <table>
        <thead>
          <tr>
            <td>Time</td>
            <td>Count</td>
            <td></td>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>
              <input ng-model="newsample.time" type="time" name="time" size="60">
            </td>
            <td>
              <input ng-model="newsample.value" type="number" min="1" name="value" size="60">
            </td>
            <td>
              <button ng-click="add()">Add</button>
            </td>
          </tr>
          <tr ng-repeat="sample in samples | orderBy:'-time'">
            <td>{(sample.time | date:'mediumTime')}</td>
            <td>{(sample.value)}</td>
            <td><!-- <button class='remove-sample-{($index)}'>Remove</button> --></td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>


{% javascript vendor/lodash.compat %}
<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/angularjs/1.2.23/angular.min.js"></script>

<script type="text/javascript">

  var sampleApp = angular.module('sampleApp', []);

  // Work around Jekyll's liquid tags.
  sampleApp.config([
    '$interpolateProvider', function($interpolateProvider) {
      return $interpolateProvider.startSymbol('{(').endSymbol(')}');
    }
  ]);

  sampleApp.controller('SampleListCtrl', function ($scope, $filter) {
    function isNumber(n) {
      return !isNaN(parseFloat(n)) && isFinite(n);
    }

    function dateFromTime(time) {
      var parts = time.split(':');
      var date = new Date();
      date.setHours(isNumber(parts[0]) ? parts[0] : 0);
      date.setMinutes(isNumber(parts[1]) ? parts[1] : 0);
      date.setSeconds(isNumber(parts[2]) ? parts[2] : 0);
      return date;
    }
    $scope.samples = [
      // {time: dateFromTime('13:34'), value: 456},
      // {time: dateFromTime('13:45'), value: 343},
      // {time: dateFromTime('13:49'), value: 123},
    ];

    $scope.add = function() {
      $scope.samples.push({
        time: $scope.newsample.time ? dateFromTime($scope.newsample.time) : new Date(),
        value: parseFloat($scope.newsample.value),
      });
      $scope.newsample = { time: null, value: null};
    };

    $scope.remove = function() {
      // TODO
    };

    $scope.target = 0;
    $scope.rate = 0;
    $scope.remaining = null;
    $scope.estimate = null;

    $scope.$watch('samples', recalc, true);

    function recalc(samples) {
      if (samples.length < 2) {
        $scope.target = 0;
        $scope.rate = 0;
        $scope.remaining = null;
        $scope.estimate = null;
        return;
      }

      samples = $filter('orderBy')(samples, '"time"');
// console.log(samples);
      var start = samples[0];
      var later = samples[samples.length - 1];

      var completed = start.value - later.value; // assumes descending?
      var intervalInMs = (later.time - start.time);
      var ratePerMs = completed / intervalInMs;
      $scope.rate = ratePerMs * 1000 * 60;
      $scope.remaining = Math.abs($scope.target - later.value);
      $scope.estimate = new Date(later.time.getTime() + ($scope.remaining / ratePerMs));
    }

  });
</script>
